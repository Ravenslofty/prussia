name: Build Prussia

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      BINUTILS_LOC: /opt/binutils-mips
      BINUTILS_TAG: binutils-2_44
      BUILD_TARGET: hello-rs
      CARGO_LOC: /root/.cargo
      RUSTUP_LOC: /root/.rustup
      TARGET: mips64el-none-elf
      TOOLCHAIN: nightly

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Cache gnu-binutils
      id: cache-binutils
      uses: actions/cache@v4
      with:
        path: ${{ env.BINUTILS_LOC }}
        key: ${{ runner.os }}-build-${{ env.TARGET }}-${{ env.BINUTILS_TAG }}

    - name: Cache Rust
      id: cache-rust
      uses: actions/cache@v4
      with:
        path: |
          ${{ env.CARGO_LOC }}
          ${{ env.RUSTUP_LOC }}
        key: ${{ runner.os }}-build-${{ env.TARGET }}-${{ env.TOOLCHAIN }}

    - name: Setup gnu-binutils
      if: ${{ steps.cache-binutils.outputs.cache-hit != 'true' }}
      run: |
        sudo apt update
        sudo apt install -y gcc make texinfo libmpc-dev bison flex
        git clone --branch ${{ env.BINUTILS_TAG }} https://sourceware.org/git/binutils-gdb.git
        cd binutils-gdb
        mkdir build
        cd build
        ../configure --target="${{ env.TARGET }}" --prefix=${{ env.BINUTILS_LOC }}
        make configure-host
        make -j$(nproc)
        sudo make install

    - name: Set up Rust toolchain
      if: ${{ steps.cache-rust.outputs.cache-hit != 'true' }}
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-unknown-linux-gnu
        toolchain: ${{ env.TOOLCHAIN }}
        components: rust-std

    - name: Update PATH
      run: |
        echo ${{ env.BINUTILS_LOC }}/bin >> $GITHUB_PATH
        echo ${{ env.CARGO_LOC }}/bin >> $GITHUB_PATH

    - name: Build hello-rs
      run: |
        cargo build --release -p hello-rs
